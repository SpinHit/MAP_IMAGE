<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <script src="exif.js"></script>
  <script src="jquery-3.6.1.min.js"></script>

  <title>Projet Visualisation</title>
  <style>
    @import url('main.css');
  </style>
</head>

<body>
  <div id='repertory'>
    <p>Importer un repertoire</p>
    <!-- On importe un repertoire à analyser avec la librairie exif.js -->
    <input type="file" id="files" name="files[]" webkitdirectory mozdirectory directory multiple />
    <!-- On affiche le resultat de l'analyse -->
    <div id="list"></div>
  </div>



  <div id="map">

    <script>

      //fonction pour importer un src comme un async defer pour les scripts js 
      function loadScript(src) {
        return new Promise(function (resolve, reject) {
          var script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      // dans list on va lister toutes les images récupérées
      var list = [];
      // listGps va contenir les images qui possèdent des coordonnées gps
      var listgps = [];
      // listdate va contenir les images qui possèdent des dates de création
      var listdate = [];


      var files = document.getElementById('files');

      // on lance tout le code quand on a importé un repertoire
      files.addEventListener('change', function (e) {
        // on met dans une variable le tableau des fichiers
        var files = e.target.files;
        // on va vérifier si les fichiers sont des images
        for (var i = 0, file; file = files[i]; i++) {
          // condition pour vérifier si les fichiers sont des images
          if (file.type.match('image.*')) {
            // on push l'image dans la liste des images crées au début
            list.push(file);
          }
        }

        // pour chaque image on va récupérer les données exif avec la librairie exif.js
        for (var i = 0; i < list.length; i++) {
          var file = list[i];
          // on récupére les données exif de l'image
          EXIF.getData(file, function () {
            var allMetaData = EXIF.getAllTags(this);
            //gps data
            if (allMetaData.GPSLatitude) { var gps = allMetaData.GPSLatitude; } else { var gps = null; }
            if (allMetaData.GPSLongitude) { var gps2 = allMetaData.GPSLongitude; } else { var gps2 = null; }
            //si gps = null on met null dans les variables lat et lng
            var lat = gps ? gps[0] + gps[1] / 60 + gps[2] / 3600 : null;
            var lng = gps2 ? gps2[0] + gps2[1] / 60 + gps2[2] / 3600 : null;
            // le : null permet de mettre null dans la variable si la condition est fausse

            // On regarde si l'image a une date de creation
            if (allMetaData.DateTimeOriginal) { var date = allMetaData.DateTimeOriginal; } else { var date = null; }

            // on récupère le chemin de l'image
            var path = this.webkitRelativePath;

            // on récupère le nom de l'image
            var name = this.name
            // on récupère le model de l'appareil photo
            var model = allMetaData.Model;
            // on récupère la marque de l'appareil photo
            var brand = allMetaData.Make;
            // on récupère la taille de l'image
            var size = this.size / 1000000 + " Mo";

            // si lat ou lng est null, on ne l'ajoute pas à la liste
            if (lat != null && lng != null) {
              listgps.push({ date, path, name, model, brand, size, lat, lng });
            }
            // si date est null, on ne l'ajoute pas à la liste
            if (date != null) {
              listdate.push({ date, path, name, model, brand, size, lat, lng });
            }


          });

        }

      });
      // on met en pause le script et on le reprend quand la liste est remplie
      var interval = setInterval(function () {
        if (listgps.length > 0) {
          // on clear l'interval pour ne pas le relancer à chaque fois que la liste est remplie  
          clearInterval(interval);

          // on lances les scripts google maps et markerclusterer
          loadScript("https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js").then(function () {
            loadScript("https://maps.googleapis.com/maps/api/js?key=AIzaSyBtjaD-saUZQ47PbxigOg25cvuO6_SuX3M&callback=initMap").then(function () {
              // on lance la fonction initMap définie plus bas qui va afficher les marqueurs sur la carte google maps
              initMap();
            });
          });

          // on affiche dans la console la liste des images avec les données récupérées
          console.log(listgps);
          console.log(listdate);

          // on remplit locations avec les données de listgps
          var locations = [];
          for (var i = 0; i < listgps.length; i++) {
            var lat = listgps[i].lat;
            var lng = listgps[i].lng;
            locations.push({ lat, lng });
          }

          function initMap() {
            // on crée la carte google maps
            var map = new google.maps.Map(document.getElementById('map'), {
              zoom: 11,
              // on met le focus de chargement de la carte sur la première image
              center: locations[0]
            });

            // on importe les images dans markers
            var labelimage = [];
            for (var i = 0; i < listgps.length; i++) {
              // on met le chemin du programme dans une variable en brut car en javascript on ne peut pas récupérer le chemin du programme pour des raisons de sécurité
              chemin = 'C:/Users/SpinHit/Desktop/MAP_IMAGE/'
              // on met dans labelimage le chemin de l'image a récupérer
              labelimage.push(chemin + listgps[i].path);
            }

            // on crée les marqueurs sur la carte google maps
            var markers = locations.map(function (location, i) {
              return new google.maps.Marker({
                // on met les coordonnées de l'image
                position: location,
                // on met l'image en tant que marqueur sur la carte google maps
                icon: {
                  // on met le chemin de l'image
                  url: labelimage[i % labelimage.length],
                  // on met la taille de l'image
                  scaledSize: new google.maps.Size(100, 100),
                  // on met le nom de l'image
                  name: listgps[i].name,
                  // on met le model de l'appareil photo
                  model: listgps[i].model,
                  // on met la marque de l'appareil photo
                  brand: listgps[i].brand,
                  // on met la taille de l'image
                  taille: listgps[i].size,
                  // on met la date de création de l'image
                  date: listgps[i].date,
                  // on met la localisation de l'image
                  Localisation: listgps[i].lat + " " + listgps[i].lng

                },
                title: 'markerpins'
              });
            });

            // on fait en sorte que quand on clique sur les marqueurs cela affiche les informations de l'image dans une infobulle
            markers.forEach(function (marker) {
              // on crée l'infobulle avec le listener click sur le marqueur
              marker.addListener('click', function () {
                // on crée l'infobulle avec les informations de l'image
                var infowindow = new google.maps.InfoWindow({
                  content: '<img src="' + marker.icon.url + '" style="width: 100%; height: 100%;">' + '<h4 class="timeline-title">' + marker.icon.name + '</h4>' + '<p>' + marker.icon.model + '</p>' + '<p>' + marker.icon.brand + '</p>' + '<p>' + marker.icon.taille + '</p>' + '<p>' + marker.icon.date + '</p>' + '<p>' + marker.icon.Localisation + '</p>'
                });
                // on affiche l'infobulle
                infowindow.open(map, marker);
              });
            });

            // on crée le cluster de marqueurs sur la carte google maps avec le script markerclusterer de google
            var markerCluster = new MarkerClusterer(map, markers,
              { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
          }
        }
      }, 1000);
    </script>
  </div>

  <div id="timeline">
    <!-- on crée une timeline avec les informations des images -->

    <div class="container">
      <div class="row">
        <div class="col-md-12">

          <div style="display:inline-block;width:100%;overflow-y:auto;">
            <p>Courbe du temps :</p>

            <ul class="timeline timeline-horizontal">

            </ul>
          </div>
        </div>
      </div>

    </div>
    <script>
      // on lance le script que quand la liste est remplie
      var interval2 = setInterval(function () {
        // on met une condition pour ne pas lancer le script si la liste est vide
        if (listdate.length > 0) {
          // on clear l'interval pour ne pas le relancer à chaque fois que la liste est remplie
          clearInterval(interval2);
          // on ajoute les images de la liste listdate à la timeline, pour chaque image on créer une carte avec les informations de l'image
          for (var i = 0; i < listdate.length; i++) {
            // https://codepen.io/ftrujilloh/pen/PpMYgJ/
            // on créer la timeline avec le code ci-dessus et on a modifié le code pour qu'il corresponde à nos besoins 
            var li = document.createElement('li');
            li.className = 'timeline-item';
            var div1 = document.createElement('div');
            div1.className = 'timeline-badge primary';
            var i1 = document.createElement('i');
            i1.className = 'glyphicon glyphicon-check';
            div1.appendChild(i1);
            var div2 = document.createElement('div');
            div2.className = 'timeline-panel';
            var div3 = document.createElement('div');
            div3.className = 'timeline-heading';
            //we add the name of the image as a title
            var h4 = document.createElement('h4');
            h4.className = 'timeline-title';
            h4.innerHTML = listdate[i].name;
            div3.appendChild(h4);
            // we add the date, the brand and the model of the camera and the size of the image and the location of the image as a subtitle
            var p = document.createElement('p');
            p.className = 'timeline-subtitle';
            p.innerHTML = 'Date : ' + listdate[i].date + '<br>Marque : ' + listdate[i].brand + '<br>Modèle : ' + listdate[i].model + '<br>Taille : ' + listdate[i].size + '<br>Localisation : ' + listdate[i].lat + ' ' + listdate[i].lng;

            div3.appendChild(p);


            var div4 = document.createElement('div');
            div4.className = 'timeline-body';
            var image = document.createElement('img');
            image.src = 'C:/Users/SpinHit/Desktop/MAP_IMAGE/' + listdate[i].path
            image.style.width = '100%';
            div4.appendChild(image);
            div2.appendChild(div3);
            div2.appendChild(div4);
            li.appendChild(div1);
            li.appendChild(div2);
            document.querySelector('#timeline ul').appendChild(li);
          }

          // au survol on agrandit la taille de l'image dans la timeline et on pousse les autres images vers la droite
          /*           var timeline = document.querySelectorAll('.timeline li');
                    for (var i = 0; i < timeline.length; i++) {
                      timeline[i].addEventListener('mouseover', function () {
                        this.style.width = '200px';
                        this.style.marginRight = '20px';
                        this.style.zIndex = '1000';
                        this.style.transition = 'all 0.5s';
                        this.style.transform = 'scale(1.3)';
                        this.style.transformOrigin = 'right';
                      });
                      timeline[i].addEventListener('mouseout', function () {
                        this.style.width = '100px';
                        this.style.marginRight = '0';
                        this.style.zIndex = '0';
                        this.style.transition = 'all 0.5s';
                        this.style.transform = 'scale(1)';
                        this.style.transformOrigin = 'right';
                      });
                    } */





        }

      }, 1000);





    </script>





</body>



</body>


</html>